---
# Webhook secret management tasks

- name: Check existing webhook secrets
  ansible.builtin.command: >
    gcloud secrets describe {{ item.name }}
    --project={{ gcp_project_id }}
  loop: "{{ webhook_secrets }}"
  register: secret_check
  changed_when: false
  failed_when: false

- name: Generate random webhook secrets
  ansible.builtin.set_fact:
    generated_secrets: "{{ generated_secrets | default({}) | combine({item.item.name: lookup('password', '/dev/null length=' + item.item.length|string + ' chars=ascii_letters,digits')}) }}"
  loop: "{{ secret_check.results }}"
  when: item.rc != 0
  no_log: true

- name: Create webhook secrets in Secret Manager
  ansible.builtin.shell: |
    echo -n "{{ generated_secrets[item.item.name] }}" | \
    gcloud secrets create {{ item.item.name }} \
      --data-file=- \
      --replication-policy=automatic \
      --project={{ gcp_project_id }}
  loop: "{{ secret_check.results }}"
  when: item.rc != 0
  register: secret_create
  changed_when: secret_create.rc == 0
  no_log: true

- name: Grant service account access to secrets
  ansible.builtin.command: >
    gcloud secrets add-iam-policy-binding {{ item.name }}
    --member="serviceAccount:{{ service_account }}"
    --role="roles/secretmanager.secretAccessor"
    --project={{ gcp_project_id }}
  loop: "{{ webhook_secrets }}"
  register: secret_iam
  changed_when: "'Updated IAM policy' in secret_iam.stdout"

- name: Display webhook secret status
  ansible.builtin.debug:
    msg:
      - "Webhook secrets configured:"
      - "  - {{ item.name }}: {{ 'created' if item.name in (generated_secrets | default({})) else 'already exists' }}"
  loop: "{{ webhook_secrets }}"
  no_log: false
