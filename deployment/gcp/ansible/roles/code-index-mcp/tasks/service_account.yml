---
# Service account setup tasks

- name: Check if service account exists
  ansible.builtin.command: >
    gcloud iam service-accounts describe {{ service_account }}
    --project={{ gcp_project_id }}
  register: sa_check
  changed_when: false
  failed_when: false

- name: Create service account
  ansible.builtin.command: >
    gcloud iam service-accounts create {{ service_name }}
    --display-name="Code Index MCP {{ env_name }}"
    --description="Service account for Code Index MCP {{ env_name }} Cloud Run"
    --project={{ gcp_project_id }}
  when: sa_check.rc != 0
  register: sa_create
  changed_when: sa_create.rc == 0

- name: Grant Secret Manager accessor role
  ansible.builtin.command: >
    gcloud projects add-iam-policy-binding {{ gcp_project_id }}
    --member="serviceAccount:{{ service_account }}"
    --role="roles/secretmanager.secretAccessor"
    --condition=None
  register: sa_secret_role
  changed_when: "'Updated IAM policy' in sa_secret_role.stdout"

- name: Grant Storage object admin role
  ansible.builtin.command: >
    gcloud projects add-iam-policy-binding {{ gcp_project_id }}
    --member="serviceAccount:{{ service_account }}"
    --role="roles/storage.objectAdmin"
    --condition=None
  register: sa_storage_role
  changed_when: "'Updated IAM policy' in sa_storage_role.stdout"

- name: Grant AI Platform user role (for Vertex AI embeddings)
  ansible.builtin.command: >
    gcloud projects add-iam-policy-binding {{ gcp_project_id }}
    --member="serviceAccount:{{ service_account }}"
    --role="roles/aiplatform.user"
    --condition=None
  register: sa_ai_role
  changed_when: "'Updated IAM policy' in sa_ai_role.stdout"

- name: Grant AlloyDB client role (if AlloyDB enabled)
  ansible.builtin.command: >
    gcloud projects add-iam-policy-binding {{ gcp_project_id }}
    --member="serviceAccount:{{ service_account }}"
    --role="roles/alloydb.client"
    --condition=None
  when: with_alloydb | bool
  register: sa_alloydb_role
  changed_when: "'Updated IAM policy' in sa_alloydb_role.stdout"

- name: Display service account setup
  ansible.builtin.debug:
    msg:
      - "Service account configured: {{ service_account }}"
      - "Roles granted: Secret Manager, Storage, AI Platform"
      - "{{ 'AlloyDB client role granted' if with_alloydb else 'AlloyDB not enabled' }}"
