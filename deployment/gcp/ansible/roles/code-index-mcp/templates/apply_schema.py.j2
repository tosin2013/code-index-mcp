#!/usr/bin/env python3
"""
Schema applier for AlloyDB.
Generated by Ansible - code-index-mcp role
"""
import os
import sys
import psycopg2
import time

def test_connectivity(conn_string, max_retries=3):
    """Test database connectivity before schema application."""
    print("=" * 60)
    print("STEP 1: Testing AlloyDB Connectivity")
    print("=" * 60)

    for attempt in range(1, max_retries + 1):
        try:
            print(f"Connection attempt {attempt}/{max_retries}...")
            conn = psycopg2.connect(conn_string, connect_timeout=10)
            cur = conn.cursor()

            # Test basic query
            cur.execute("SELECT version();")
            version = cur.fetchone()[0]
            print(f"âœ“ Connection successful!")
            print(f"  Database version: {version[:80]}...")

            # Test pgvector extension
            cur.execute("SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';")
            result = cur.fetchone()
            if result:
                print(f"âœ“ pgvector extension: {result[1]}")
            else:
                print("âš  Warning: pgvector extension not found")

            cur.close()
            conn.close()
            print()
            return True

        except psycopg2.OperationalError as e:
            print(f"âœ— Connection failed: {e}")
            if attempt < max_retries:
                wait_time = attempt * 2
                print(f"  Retrying in {wait_time} seconds...")
                time.sleep(wait_time)
            else:
                print(f"\nâŒ CONNECTIVITY TEST FAILED after {max_retries} attempts", file=sys.stderr)
                return False
        except Exception as e:
            print(f"âœ— Unexpected error: {e}", file=sys.stderr)
            return False

    return False

def apply_schema(conn_string):
    """Apply database schema to AlloyDB."""
    print("=" * 60)
    print("STEP 2: Applying Database Schema")
    print("=" * 60)

    try:
        conn = psycopg2.connect(conn_string)
        conn.autocommit = True
        cur = conn.cursor()

        # Read schema SQL file
        print("Reading schema file...")
        with open('/app/alloydb-schema.sql', 'r') as f:
            schema_sql = f.read()

        print(f"Schema file size: {len(schema_sql)} bytes")
        print("\nExecuting schema SQL...")

        # Execute schema SQL
        cur.execute(schema_sql)
        print("âœ“ Schema SQL executed successfully")

        cur.close()
        conn.close()
        print()
        return True

    except Exception as e:
        print(f"\nâŒ SCHEMA APPLICATION FAILED: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc()
        return False

def verify_schema(conn_string):
    """Verify required tables exist."""
    print("=" * 60)
    print("STEP 3: Verifying Schema Application")
    print("=" * 60)

    required_tables = ['users', 'projects', 'code_chunks']

    try:
        conn = psycopg2.connect(conn_string)
        cur = conn.cursor()

        # Get all tables
        cur.execute("""
            SELECT table_name
            FROM information_schema.tables
            WHERE table_schema = 'public'
            ORDER BY table_name
        """)

        tables = [row[0] for row in cur.fetchall()]
        print(f"Tables found: {', '.join(tables) if tables else 'NONE'}")
        print()

        # Check required tables
        missing_tables = []
        for table in required_tables:
            if table in tables:
                print(f"âœ“ {table} table exists")
            else:
                print(f"âœ— {table} table MISSING")
                missing_tables.append(table)

        cur.close()
        conn.close()

        if missing_tables:
            print(f"\nâŒ VERIFICATION FAILED: Missing tables: {', '.join(missing_tables)}", file=sys.stderr)
            return False

        print("\nâœ… SCHEMA VERIFICATION SUCCESSFUL")
        print("=" * 60)
        return True

    except Exception as e:
        print(f"\nâŒ VERIFICATION FAILED: {e}", file=sys.stderr)
        return False

def main():
    """Main execution flow."""
    # Get connection string from environment (support both variable names)
    conn_string = os.environ.get('DATABASE_URL') or os.environ.get('ALLOYDB_CONNECTION_STRING')
    if not conn_string:
        print("âŒ ERROR: DATABASE_URL or ALLOYDB_CONNECTION_STRING not set", file=sys.stderr)
        return 1

    print("\n" + "=" * 60)
    print("AlloyDB Schema Application")
    print("=" * 60)
    print()

    # Step 1: Test connectivity
    if not test_connectivity(conn_string):
        return 1

    # Step 2: Apply schema
    if not apply_schema(conn_string):
        return 1

    # Step 3: Verify schema
    if not verify_schema(conn_string):
        return 1

    print("\nðŸŽ‰ ALL STEPS COMPLETED SUCCESSFULLY!")
    return 0

if __name__ == '__main__':
    sys.exit(main())
