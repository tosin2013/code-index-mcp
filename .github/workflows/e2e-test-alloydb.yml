name: E2E Test - AlloyDB Semantic Search

on:
  # Weekly scheduled test (full redeploy)
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        type: choice
        options:
          - fast  # DB reset only (~5-10 min)
          - full  # Full teardown + redeploy (~25-35 min)
        default: 'fast'
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - dev
          - staging
        default: 'dev'

  # Run on pull requests that affect deployment or tests
  pull_request:
    paths:
      - 'deployment/**'
      - 'tests/ansible/**'
      - 'src/code_index_mcp/ingestion/**'
      - 'src/code_index_mcp/embeddings/**'
      - 'src/code_index_mcp/services/semantic_search_service.py'
      - '.github/workflows/e2e-test-alloydb.yml'

jobs:
  # ============================================================================
  # Job 1: Fast E2E Test (DB Reset)
  # ============================================================================
  fast-e2e-test:
    name: Fast E2E Test (DB Reset)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'fast') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 2 * * 1')

    env:
      TEST_ENV: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install google.cloud
          ansible-galaxy collection install community.docker
          ansible-galaxy collection install tosin2013.mcp_audit

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run Fast E2E Test
        id: fast_test
        run: |
          cd tests/ansible
          ansible-playbook test-e2e-db-reset.yml \
            -i inventory/${{ env.TEST_ENV }}.yml \
            -e "gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -v
        continue-on-error: true

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fast-e2e-test-report-${{ env.TEST_ENV }}-${{ github.run_number }}
          path: tests/ansible/fast-e2e-test-report-*.md
          retention-days: 30

      - name: Comment on PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testReports = fs.readdirSync('tests/ansible')
              .filter(f => f.startsWith('fast-e2e-test-report-'));

            if (testReports.length > 0) {
              const report = fs.readFileSync(`tests/ansible/${testReports[0]}`, 'utf8');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸš€ Fast E2E Test Results\n\n${report}\n\n**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            }

      - name: Check test status
        if: steps.fast_test.outcome == 'failure'
        run: |
          echo "::error::Fast E2E test failed"
          exit 1

  # ============================================================================
  # Job 2: Full E2E Test (Teardown + Redeploy)
  # ============================================================================
  full-e2e-test:
    name: Full E2E Test (Teardown + Redeploy)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'full')

    env:
      TEST_ENV: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install google.cloud
          ansible-galaxy collection install community.docker
          ansible-galaxy collection install tosin2013.mcp_audit

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Display test warning
        run: |
          echo "âš ï¸  FULL E2E TEST - DESTRUCTIVE"
          echo "This will:"
          echo "  - Delete AlloyDB cluster"
          echo "  - Delete Cloud Run service"
          echo "  - Redeploy everything"
          echo ""
          echo "Duration: ~25-35 minutes"
          echo "Cost: ~$0.25-0.50"

      - name: Run Full E2E Test
        id: full_test
        run: |
          cd tests/ansible
          echo "I understand and want to proceed" | ansible-playbook test-e2e-full-redeploy.yml \
            -i inventory/${{ env.TEST_ENV }}.yml \
            -e "gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -v
        timeout-minutes: 45
        continue-on-error: true

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-e2e-test-report-${{ env.TEST_ENV }}-${{ github.run_number }}
          path: tests/ansible/e2e-test-report-*.md
          retention-days: 90

      - name: Send notification on failure
        if: steps.full_test.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Full E2E Test Failed - Run #${{ github.run_number }}`,
              body: `The full E2E test (teardown + redeploy) has failed.\n\n**Environment:** ${{ env.TEST_ENV }}\n**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n**Action Required:**\n- Check test logs for errors\n- Verify infrastructure state\n- Manual intervention may be needed`,
              labels: ['bug', 'e2e-test', 'high-priority']
            });

      - name: Check test status
        if: steps.full_test.outcome == 'failure'
        run: |
          echo "::error::Full E2E test failed"
          exit 1

  # ============================================================================
  # Job 3: Test Results Summary
  # ============================================================================
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [fast-e2e-test]
    if: always()

    steps:
      - name: Download all test reports
        uses: actions/download-artifact@v4
        with:
          path: test-reports

      - name: Generate summary
        run: |
          echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "test-reports" ]; then
            for report_dir in test-reports/*; do
              if [ -d "$report_dir" ]; then
                echo "### $(basename $report_dir)" >> $GITHUB_STEP_SUMMARY
                for report in $report_dir/*.md; do
                  if [ -f "$report" ]; then
                    cat "$report" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi
                done
              fi
            done
          else
            echo "No test reports found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall status
        run: |
          if [[ "${{ needs.fast-e2e-test.result }}" == "failure" ]]; then
            echo "::error::E2E tests failed"
            exit 1
          fi
          echo "âœ… All E2E tests passed"
