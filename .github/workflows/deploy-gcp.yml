name: Deploy to Google Cloud Platform

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.5.0'
  ANSIBLE_VERSION: '2.14'
  GCP_REGION: 'us-east1'

jobs:
  # Stage 1: Security Scanning
  security:
    name: Security Scans
    uses: ./.github/workflows/security-scan.yml
    secrets: inherit

  # Stage 2: Unit and Integration Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: security
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync --extra gcp

      - name: Run unit tests
        run: |
          uv run pytest tests/ -v --tb=short

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            test-results/
            coverage.xml

  # Stage 3: Build and Push Container Image
  build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: [security, test]
    if: always() && (needs.security.result == 'success') && (needs.test.result == 'success' || inputs.skip_tests)
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Set up GCP authentication
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/code-index-mcp/server
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=${{ steps.env.outputs.environment }}-{{sha}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/gcp/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            COMMIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Output image details
        run: |
          echo "Image: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  # Stage 4: Deploy Infrastructure with Terraform
  deploy-infrastructure:
    name: Deploy Infrastructure (Terraform)
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ needs.build.outputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up GCP authentication
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Init
        working-directory: deployment/gcp/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_TERRAFORM_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ steps.env.outputs.environment }}"

      - name: Terraform Plan
        working-directory: deployment/gcp/terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -var="environment=${{ steps.env.outputs.environment }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: deployment/gcp/terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: Save Terraform outputs
        id: tf-outputs
        working-directory: deployment/gcp/terraform
        run: |
          terraform output -json > terraform-outputs.json
          echo "vpc_connector=$(terraform output -raw vpc_connector_name)" >> $GITHUB_OUTPUT
          echo "alloydb_instance=$(terraform output -raw alloydb_instance_name)" >> $GITHUB_OUTPUT

      - name: Upload Terraform outputs
        uses: actions/upload-artifact@v3
        with:
          name: terraform-outputs
          path: deployment/gcp/terraform/terraform-outputs.json

  # Stage 5: Deploy Application with Ansible
  deploy-application:
    name: Deploy Application (Ansible)
    runs-on: ubuntu-latest
    needs: [build, deploy-infrastructure]
    environment:
      name: ${{ needs.build.outputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up GCP authentication
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible-galaxy collection install -r deployment/gcp/ansible/requirements.yml

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Download Terraform outputs
        uses: actions/download-artifact@v3
        with:
          name: terraform-outputs
          path: /tmp/

      - name: Run Ansible deployment
        working-directory: deployment/gcp/ansible
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ env.GCP_REGION }}
          CONTAINER_IMAGE: ${{ needs.build.outputs.image_tag }}
        run: |
          ansible-playbook deploy.yml \
            -i inventory/${{ steps.env.outputs.environment }}.yml \
            -e "gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -e "gcp_region=${{ env.GCP_REGION }}" \
            -e "container_image=${{ needs.build.outputs.image_tag }}" \
            -e "environment=${{ steps.env.outputs.environment }}" \
            -v

      - name: Get service URL
        id: service-url
        run: |
          SERVICE_URL=$(gcloud run services describe code-index-mcp-${{ steps.env.outputs.environment }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service deployed at: $SERVICE_URL"

      - name: Output deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: ${{ steps.service-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY

  # Stage 6: Verify Deployment with MCP Tests
  verify:
    name: Verify Deployment (MCP Tests)
    runs-on: ubuntu-latest
    needs: [deploy-application]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible and MCP Audit Collection
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible-galaxy collection install tosin2013.mcp_audit

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Run MCP validation tests
        working-directory: tests/ansible
        env:
          CLOUDRUN_SERVICE_URL: ${{ needs.deploy-application.outputs.url }}
          MCP_API_KEY: ${{ secrets.MCP_API_KEY_DEV }}
        run: |
          ansible-playbook test-cloud.yml \
            -i inventory/gcp-${{ steps.env.outputs.environment }}.yml \
            -e "cloudrun_service_url=${{ env.CLOUDRUN_SERVICE_URL }}" \
            -e "mcp_api_key=${{ env.MCP_API_KEY }}" \
            -v

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: mcp-test-results
          path: tests/ansible/test-results/

  # Final: Deployment Complete
  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [verify]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.verify.result }}" == "success" ]; then
            echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All stages completed successfully:" >> $GITHUB_STEP_SUMMARY
            echo "- Security scans passed" >> $GITHUB_STEP_SUMMARY
            echo "- Tests passed" >> $GITHUB_STEP_SUMMARY
            echo "- Container image built and pushed" >> $GITHUB_STEP_SUMMARY
            echo "- Infrastructure deployed" >> $GITHUB_STEP_SUMMARY
            echo "- Application deployed" >> $GITHUB_STEP_SUMMARY
            echo "- MCP validation tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed or incomplete**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
